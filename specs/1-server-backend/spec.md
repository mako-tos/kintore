
# サーバサイド機能 仕様書

**Feature Branch**: `1-server-backend`
**作成日**: 2025-10-26
**ステータス**: 下書き
**入力**: ユーザー説明: "サーバサイド機能"

## Clarifications

### Session 2025-11-01

- Q1: Resource identity → A: サーバ生成の不透明ID (UUIDv4)
- Q2: Availability/SLA → A: SLAなし（ベストエフォート）

## データモデル/エンティティの明確化

### TrainingMenu(データモデル)
|要素名|データ型|必須|説明|
|---|---|---|---|
|id|string|〇|UUID|
|name|string|〇|トレーニング名|
|status|number|〇|0:有効, 1:無効|
レコードの物理削除は禁止し、削除する場合は必ずstatusを1に変える

### TrainingRecord(データモデル)
|要素名|データ型|説明|
|---|---|---|---|
|id|string|〇|UUID|
|trainingMenuId|string|〇|トレーニングメニューのID|
|trainingAt|date|〇|トレーニング実施日時|
|count|number|〇|トレーニング実施回数(1以上)|

## ユーザーシナリオ & テスト

### ユーザーストーリー1 - 初期表示データ読み込み (優先度: P1)
1. TrainingMenuをデータストアからJSON形式で取得する
- 条件:statusが0
1. TrainingRecordをデータストアからJSON形式で取得する
- 条件1:trainingAtが当日
- 条件2:trainingMenuIdと一致するTrainingMenuが存在する

**優先理由**: クライアント向け機能の前提となるプラットフォームの基本機能。

**独立テスト**:
- 各データソースの条件に合致するデータの単体テスト。
- 各データソースの条件に合致しないデータの単体テスト。
- 各データソースにデータがない場合の単体テスト。
- 各データソースにアクセス失敗した場合のエラーハンドリングの単体テスト。

**受け入れシナリオ**:

1. **前提**: 有効なリクエスト、**操作**: クライアントがGETエンドポイントを呼び出す、**結果**: 一致するデータが表示される。

---

### ユーザーストーリー2 - TrainingMenuの追加 (優先度: P2)
**概要**: JSON形式でTrainingMenuを受け取り、データソースに追加する

**優先理由**: データがないと基本機能が動かない。

**独立テスト**:
- TrainingMenuのデータ整合性を検証し失敗した場合のデータハンドリングをする単体テスト。
- TrainingMenuのデータ整合性を検証し成功後にデータソースに登録されていることを確認する単体テスト。

**受け入れシナリオ**:

1. **前提**: 登録可能データをJSON形式で渡す。**操作**: クライアントがリクエスト送信。**結果**: データソースの追記。
2. **前提**: 検証に失敗するデータをJSON形式で渡す。**操作**: クライアントがリクエスト送信。**結果**: エラー内容に応じたエラーメッセージの返信。

---

### ユーザーストーリー3 - TrainingMenuの変更 (優先度: P3)
**概要**: JSON形式でTrainingMenuを受け取り、データソースを更新する。更新対象はidが一致するもの。

**優先理由**: 後からトレーニング内容の変更が必要。

**独立テスト**:
- TrainingMenuのデータ整合性を検証し失敗した場合のデータハンドリングをする単体テスト。
- TrainingMenuのデータ整合性を検証し成功後にデータソースに登録されていることを確認する単体テスト。

**受け入れシナリオ**:

1. **前提**: 更新可能データをJSON形式で渡す。**操作**: クライアントがリクエスト送信。**結果**: データソースの追記。
2. **前提**: 検証に失敗するデータをJSON形式で渡す。**操作**: クライアントがリクエスト送信。**結果**: エラー内容に応じたエラーメッセージの返信。

---

### ユーザーストーリー4 - TrainingMenuの削除 (優先度: P4)
**概要**: idを受け取り、データソースの該当データを無効に更新する。物理削除は行わない。

**優先理由**: やらなくなったトレーニング内容の削除が必要。

**独立テスト**:
- TrainingMenuに存在しないidを指定した場合のデータハンドリングをする単体テスト。
- TrainingMenuに存在するidを指定した場合に当該データのstatusが1になることを確認する単体テスト。

**受け入れシナリオ**:

1. **前提**: 存在するidを渡す。**操作**: クライアントがリクエスト送信。**結果**: データソースの更新。
2. **前提**: 存在しないidを渡す。**操作**: クライアントがリクエスト送信。**結果**: エラーメッセージ`トレーニングメニューが見つかりません`の返信。

---

### ユーザーストーリー5 - TrainingRecord配列の登録 (優先度: P5)
**概要**: TrainingRecordの配列をJSON形式で受け取り、データソースに追加する。

**優先理由**: メイン機能。

**独立テスト**:
- 空配列を指定した場合のデータハンドリングをする単体テスト。
- 1個のTrainingRecord配列を指定した場合で、TrainingMenuに存在しないtrainingMenuIdを指定した場合のデータハンドリングをする単体テスト。
- 複数個のTrainingRecord配列を指定した場合で、一部にTrainingMenuに存在しないtrainingMenuIdを指定した場合のデータハンドリングをする単体テスト。
- 1個のTrainingRecord配列を指定した場合にデータソースに登録する単体テスト。
- 複数個のTrainingRecord配列を指定した場合にデータソースに登録する単体テスト。

**受け入れシナリオ**:

1. **前提**: 複数個のTrainingRecord配列を渡す。**操作**: クライアントがリクエスト送信。**結果**: データソースの追記。
2. **前提**: データ不整合のあるTrainingRecord配列を渡す。**操作**: クライアントがリクエスト送信。**結果**: エラーメッセージ`変なトレーニングが見つかりました。`の返信。

---

### ユーザーストーリー6 - 可観測性と運用診断 (優先度: P6)
エンジニアとして、サーバーサイド処理の構造化ログとメトリクスが欲しい。リクエストの追跡や障害診断を迅速に行いたい。

**優先理由**: 運用可視性によりインシデント対応時間を短縮。

**独立テスト**: 主要パスでログ/メトリクスが出力されることを確認するスモークテスト、IDでトレースを相関できるかの手動/自動チェック。

**受け入れシナリオ**:

1. **前提**: エラー発生リクエスト、**操作**: エラー発生、**結果**: 相関IDとエラー詳細付きの構造化ログが出力される。
2. **前提**: 通常トラフィック、**操作**: リクエスト処理、**結果**: リクエスト数・エラー率・処理遅延などのメトリクスが記録される。

---

### エッジケース

- 下流サービスが利用不可の場合: システムはキューイングまたは明確なエラーと対処方法を返すべき。
- 重複リクエスト: 書き込み系エンドポイントは冪等性を必ずドキュメント化。

## 要件

### 機能要件

- **FR-001**: システムは主要ビジネスリソースの作成・取得・更新・削除を行うGoogleAppScript APIを公開し、明確な成功・エラーコードを返すこと。
- **FR-002**: システムは入力を検証し、クライアント向けに機械可読なエラー詳細(JSONのコード・メッセージ)を返すこと。
- **FR-003**: システムは長時間タスクのバックグラウンド処理をサポートし、ジョブステータスのエンドポイントを公開すること。
- **FR-004**: システムは主要な運用指標(リクエスト数・エラー率・遅延)の構造化ログ・メトリクスを出力すること。
- **FR-005**: システムは全公開エンドポイントのHTTPリクエスト/レスポンス形式を検証するコントラクトテストを含むこと。

*前提条件*:
- 本番環境では認証・認可が必須。初期段階では内部ネットワーク限定(Option C)とし、VPNやネットワーク制御・プラットフォームのシークレットストアによるサービス間認証を前提とする。
  - 実装・テストは内部クライアント向けのトークン検証・認可チェックを含むが、OAuth/OIDC等の外部公開認証は本マイルストーンでは設計しない。外部公開時はOAuth2/OIDCへの移行計画が必要。
- クライアント通信はHTTP/HTTPS、JSONが主な交換フォーマット。

### 主なエンティティ

- **Resource**: TrainingMenu, TrainingRecord
- **Job**: バックグラウンド処理単位(id, status, created_at, attempts)
- **ErrorDetail**: 機械可読なエラーオブジェクト(code, message, details)

## 成功基準

### 測定可能な成果

- **SC-001**: 有効なAPIリクエストの95%が代表的な負荷下で500ms以内に2xx応答(ステージング環境で測定)
- **SC-002**: 全公開エンドポイントのコントラクトテストが100%カバーされ、CIで合格しない限り関連変更はマージ不可
- **SC-003**: バックグラウンドジョブの99%以上がSLA内で完了し、失敗時はリトライ・記録が行われる
- **SC-004**: 可観測性: リクエストトレースは相関IDを含み、ログは構造化フィールドで95パーセンタイル障害診断が1時間以内に可能

## 成功基準メモ
- 上記数値は初期目標であり、実装計画で負荷試験結果に応じて調整可能

- 可用性(SLA): 本イテレーションでは明確なSLAを定めず、ベストエフォートで運用する（将来的なSLA設定は計画フェーズで検討）。

## 前提

- 本機能はプラットフォームレベルのサーバー機能であり、複数クライアント(ウェブ・モバイル・バッチ等)から利用される可能性がある
- 通信はHTTP/HTTPS・JSONペイロード
- 永続ストレージやワーカー基盤は実装計画で整備・前提とする

## 範囲外

- UI/クライアント実装は本機能の範囲外
- 言語・ランタイム等の技術選定は本仕様書では明記しない

## 次のステップ

1. 認証方式(Q1)の確定後、計画書(plan.md)作成
2. エンドポイント・データモデル・テストマトリクスを計画書に記載
3. コントラクトテストとワーカープロトタイプをサンドボックス環境で作成

---

**計画フェーズ準備完了**: はい (Q1認証方式確定済み)
